# Thread
## Thread 란?
---
응용 프로그램자체 는 *프로세스* 라고 부르는 공간에서 수행된다. 개별 프로세스는 자신만의 가상 주소 공간을 가지고 있고 다른 *프로세스가 자신의 코드나 데이터에 접근을 제한한다*.  

***Thread*는  프로세스 내에서 실행되는 흐름의 단위를 의미합니다.** 일반적인 프로그램은 하나의 스레드를 가지지만, 프로그램 환경에 따라 다수의 Thread를 동시에 실행할 수 있다, 이런 방식을 Multi Thread라고한다.

## Thread의 비용
---
Thread는 생성시 비용이 많이든다. 다음과 같은 비용을 하나씩은 가진다. 
1. **스레드 커널 객체**
   1. OS는 개별 스레드별로 고유의 데이터 구조체를 할당하고 초기화 한다. 
   2. 그 데이터 구조에 '컨텍스트'라는 정보도 포함이 되어있다
   3. 컨텍스트는 CPU 내 레지스터들의 값을 저장하고 있는 메모리 블럭이다(64기준 1240byte )
2. **스레드 환경 블록**
   1. 스레드의 컨텍스트 정보, 유저모드(모든 응용프로그램이 빠르게 접근하는 주소공간) TIB 라고한다.
3. **유저모드 스택**
   1. 지역변수와 함수의 매개변수를 저장, 함수가 반환시 다음으로 수행할 주소값을 기억(1mb)
4. **커널모드 스택**
   1. 커널 모드함수로 매개변수를 잘 전달해야 할 때 사용(12~24kb)
5. **DLL의 스레드 attach/detach 퉁지**
   1. 스레드가 생성/종료 시 모든 비관리 DLL 들에게 스레드 생성/종료를 알린다.
   2. 일부 프로세스의 경우 수백개의 DLL을 사용하기도 하기떄문에 비용이 크다.
   

위 사항에 스레드 교체시 **켄텍스트 전환**이라는 비용이 발생한다. 해당 과정은 아래와 같다.

1. 현재 수행중인 스레드의 CPU 레지스터를 스레드의 컨텍스트 구조체에 저장
2. 가상 메모리 주소를 전환
3. 새 작업을 수행할 스레드의 컨텍스트 구조체 값을 CPU 레지스터로 로드

해당 작업은 상당한 비용을 초래할수 있다. 만약 CPU가 컨텍스트 전환 없이 계속 이전 스레드를 수행한다면 CPU 캐시를 많이 활용하지만 전환된다면 CPU 캐시 내용이 쓸모가 없어진다.  

가비지 진행시 CLR은 모든 스레드를 일시 정지 시킨다.

## Thread 우선순위
---
윈도우에선 `프로세스가 아니라 스레드를 스케줄의 대상`으로 가진다.

스레드의 우선순위는 프로세스의 우선순위 + 상대 스레드의 우선순위를 조합하여 정해진다. 레벨은 0~31까지 존재한다.

